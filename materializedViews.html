

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Materialized Views &mdash; GOR Open Source v.2.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/gorpipe.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Parallelization in GOR" href="parallelGOR.html" />
    <link rel="prev" title="Variation Data" href="variantData.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <nav class="wy-master-nav">
    <div class="gor-logo-home">
        <a href="index.html">
            <img src="_static/GORLogoText.svg" class="logo" />
        </a>
    </div>
    <div role="search" class="wxnc-search-form">
        <button class="wxnc-search-button" form="wxnc-search-form" formmethod="get">
            <i class="fa fa-search" aria-hidden="true"> </i>
        </button>
        <form id="wxnc-search-form" class="wy-form" action="search.html" method="get">
            <input class="wxnc-no-right-border" size="30" type="text" name="q" placeholder="Search the user manual..."/>
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>
    </div>
</nav>

  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            
            
              <div class="version">
                <a href="index.html">
                  GOR Open Source
                  <p class="wxnc-subtitle">Documentation</p>
                </a>
              </div>
            
          

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="introduction.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="basicGORqueries.html">GOR and NOR</a></li>
<li class="toctree-l2"><a class="reference internal" href="filteringStreams.html">Filtering Streams</a></li>
<li class="toctree-l2"><a class="reference internal" href="columnModifications.html">Column Modifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="groupingAndAggregation.html">Grouping and Aggregation</a></li>
<li class="toctree-l2"><a class="reference internal" href="nestedStreams.html">Nested Streams</a></li>
<li class="toctree-l2"><a class="reference internal" href="joiningTables.html">Joining Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="mapMultimap.html">Map and Multimap</a></li>
<li class="toctree-l2"><a class="reference internal" href="pivoting.html">Pivoting</a></li>
<li class="toctree-l2"><a class="reference internal" href="sequenceReads.html">Sequence Reads</a></li>
<li class="toctree-l2"><a class="reference internal" href="variantData.html">Variation Data</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Materialized Views</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#virtual-relations">Virtual Relations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#defining-macros">Defining Macros</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reusing-virtual-relations">Reusing Virtual Relations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-virtual-relations-within-functions">Using Virtual Relations Within Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#table-functions">Table Functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="parallelGOR.html">Parallelization in GOR</a></li>
<li class="toctree-l2"><a class="reference internal" href="notebooks.html">Using GOR in Notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#what-is-gor">What is GOR?</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#writing-gor-queries">Writing GOR queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#reference-data">Reference Data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="commands.html">Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="functions.html">Functions</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">GOR Open Source</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="introduction.html">Tutorials</a> &raquo;</li>
        
      <li>Materialized Views</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="materialized-views">
<span id="materializedviews"></span><h1>Materialized Views<a class="headerlink" href="#materialized-views" title="Permalink to this headline">¶</a></h1>
<p>The GOR Query Language has a <a class="reference internal" href="command/DEF.html#def"><span class="std std-ref">DEF</span></a> command to define simple C-like preprocessing macros and aliases and a <a class="reference internal" href="command/CREATE.html#create"><span class="std std-ref">CREATE</span></a> command that allows query expressions to be materialized into intermediate tables. These can be useful to build queries or <em>make queries</em> in stages and can reduce computation time if they are often referred to, especially when computation to disk-space ratio is high.</p>
<p>In other words, GOR allows you to define virtual tables and macros for result sets that you may wish to reuse when writing queries.</p>
<div class="section" id="virtual-relations">
<span id="virtualrelations"></span><h2>Virtual Relations<a class="headerlink" href="#virtual-relations" title="Permalink to this headline">¶</a></h2>
<p>To create an intermediate table a special notation is often used wrapping the name of the intermediate table like <code class="docutils literal notranslate"><span class="pre">##Name##</span></code>. However, any alphanumeric string can be used. The whole statement must end in a semi-colon to separate it from the rest of the query. A <a class="reference internal" href="command/CREATE.html#create"><span class="std std-ref">CREATE</span></a> statement can be written for any valid gor query. For example, the following:</p>
<div class="highlight-gor notranslate"><div class="highlight"><pre><span></span><span class="nd">create</span> ##VEP_Relevant## = <span class="nd">gor</span> #VEP# | <span class="nb">WHERE</span> <span class="na">Max_Impact</span> IN (&#39;HIGH&#39;,&#39;MODERATE&#39;);
</pre></div>
</div>
<p>will create an intermediate table (called <code class="docutils literal notranslate"><span class="pre">##VEP_Relevant##</span></code>) of variant effect predictions that only includes high and moderate impact results, which can then be used in a statement such as:</p>
<div class="highlight-gor notranslate"><div class="highlight"><pre><span></span><span class="nd">gor</span> #wesVars# | <span class="nb">JOIN</span> -<span class="no">snpsnp</span> [##VEP_Relevant##]
</pre></div>
</div>
<p>As you can see above, the name of the intermediate table must be referred to in square brackets containing the name of table.</p>
</div>
<div class="section" id="defining-macros">
<span id="definingmacros"></span><h2>Defining Macros<a class="headerlink" href="#defining-macros" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="command/DEF.html#def"><span class="std std-ref">DEF</span></a> command allows you to define macros with any number of input variables, which can be used and reused in gor queries. The general syntax of defining a macros using <a class="reference internal" href="command/DEF.html#def"><span class="std std-ref">DEF</span></a> is shown in the following example where we are creating a macro called <code class="docutils literal notranslate"><span class="pre">macro_name</span></code> with two variables.</p>
<div class="highlight-gor notranslate"><div class="highlight"><pre><span></span><span class="nd">def</span> macro_name($1,$2) = macro_definition;
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>As with CREATE commands, the DEF command must be terminated with a semi-colon.</p>
</div>
<p>The macro shown below which we call “prefixes”, takes the two variables (<code class="docutils literal notranslate"><span class="pre">$1</span></code> and <code class="docutils literal notranslate"><span class="pre">$2</span></code>) and uses them as prefixes for columns #3 and #4. As we can see in the second line, the macro is then given two values for the variables <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code>, which are then prepended onto the Reference and Call columns of the single row returned from the <code class="docutils literal notranslate"><span class="pre">#dbsnp#</span></code> table.</p>
<div class="highlight-gor notranslate"><div class="highlight"><pre><span></span><span class="nd">def</span> prefixes($1,$2) = <span class="nb">PREFIX</span> #3 $1 | <span class="nb">PREFIX</span> #4 $2;
<span class="nd">gor</span> #dbsnp# | <span class="nb">TOP</span> 1 | prefixes(A,B)
</pre></div>
</div>
<p>As can be seen in the following sections, you can use virtual relations within your macro to retrieve data sets in an elegant manner.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A list of pre-defined functions can be found on the <a class="reference internal" href="functions.html#predefinedfunctions"><span class="std std-ref">chapter on Functions</span></a>.</p>
</div>
</div>
<div class="section" id="reusing-virtual-relations">
<span id="reusingvirtualrelations"></span><h2>Reusing Virtual Relations<a class="headerlink" href="#reusing-virtual-relations" title="Permalink to this headline">¶</a></h2>
<p>Intermediate relations are most useful when referring to a result set multiple times within a query. In the following example, we are only interested in GWAS results of high significance and for a subset of phenotypes, e.g. related to cancer. We can inspect if SNPs associated with cancer are closely spaced in the genome, as in the following example:</p>
<div class="highlight-gor notranslate"><div class="highlight"><pre><span></span><span class="nd">create</span> ##GWASsubset## = <span class="nd">gor</span> snp_gwas_results.gorz | <span class="nb">WHERE</span> pval &lt; 1.0e-4 and contains(phenotype,’cancer’);

<span class="nd">gor</span> [##gwassubset##] | <span class="nb">WHERE</span> pval &lt; 1.0e-10
| <span class="nb">PREFIX</span> #2- A | <span class="nb">JOIN</span> -<span class="no">snpsnp</span> -<span class="no">f</span> 100000 -rprefix B [##gwassubset##]
| <span class="nb">WHERE</span> <span class="ni">NOT</span> (A_phenotype = B_phenotype and A_pos = B_pos)
| <span class="nb">RANK</span> 1 B_pval -o asc | <span class="nb">WHERE</span> rank_B_pval &lt;= 10
</pre></div>
</div>
<p>In this example, we form a join beween all the strongly significant cancer associations and other weakly significant associations within a 100kb distance. For each locus from the left-source, we rank the associations from the right-source and return only the top-ten most interesting associations. If we change for instance the allowed overlap distance, the virtual relation [##GWASsubset##] will not have to be re-executed, unless the source file snp_gwas_results.gorz is modified or the create definition changed.</p>
</div>
<div class="section" id="using-virtual-relations-within-functions">
<h2>Using Virtual Relations Within Functions<a class="headerlink" href="#using-virtual-relations-within-functions" title="Permalink to this headline">¶</a></h2>
<p>For the next step, let’s say we had already calculated the linkage disequilibrium between every marker in a 10Mbase window and stored this in one very large relation (approx. 50 billion rows) of the form (chrom,pos1,maker1,pos2,marker2,rsquare). If we assume that this relation is represented with the alias <code class="docutils literal notranslate"><span class="pre">#LD#</span></code>, an LD version of previous example can be written as:</p>
<div class="highlight-gor notranslate"><div class="highlight"><pre><span></span><span class="nd">def</span> LDjoin($1,$2) = <span class="nb">PREFIX</span> #2- A | <span class="nb">JOIN</span> -<span class="no">snpsnp</span> #LD# | <span class="nb">WHERE</span> A_mrkName = marker1
| <span class="nb">WHERE</span> abs(pos2-A_pos) &lt; $2/2 | <span class="nb">SELECT</span> #1,pos2,2- | <span class="nb">SORT</span> $2 | <span class="nb">JOIN</span> -<span class="no">snpsnp</span> -rprefix B $1
| <span class="nb">WHERE</span> B_mrkName = marker2 | <span class="nb">CALC</span> bpDist B_pos-A_pos | <span class="nb">HIDE</span> pos2x-marker2
| <span class="nb">SELECT</span> #1,A_*,B_* | <span class="nb">SORT</span> $2;

<span class="nd">create</span> ##GWASsubset## = <span class="nd">gor</span> snp_gwas_results.gorz | <span class="nb">WHERE</span> pval &lt; 1.0e-4 and contains(phenotype,’cancer’);

<span class="nd">gor</span> [##gwassubset##] | <span class="nb">WHERE</span> pval &lt; 1.0e-10
| LDjoin([##gwassubset##],100000)
| <span class="nb">WHERE</span> <span class="ni">NOT</span> (A_phenotype = B_phenotype and A_pos = B_pos)
| <span class="nb">RANK</span> 1 B_pval -o asc | <span class="nb">WHERE</span> rank_B_pval &lt;= 10
</pre></div>
</div>
<p>The above <strong>LDjoin</strong> definition, which takes two parameters, can be considered as a parameterised SQL view definition. Notice how the LDjoin uses the <a class="reference internal" href="command/SELECT.html#select"><span class="std std-ref">SELECT</span></a> command to move pos2 column into the “GOR position column”, because the <a class="reference internal" href="command/JOIN.html#join"><span class="std std-ref">JOIN</span></a> command only performs spatial joins on the first columns. Since this operation cannot guarantee genomic order, where there are multiple rows in the left-stream, we have to apply the <a class="reference internal" href="command/SORT.html#sort"><span class="std std-ref">SORT</span></a> command. The sort window takes into account the maximum deviation from genomic order. This deviation is governed by the #LD# relation and the filtering “abs(pos2-A_pos)”.</p>
<p>Again, the fact that the <a class="reference internal" href="command/SORT.html#sort"><span class="std std-ref">SORT</span></a> command has a very efficient sliding window implementation makes it possible to perform the sort without saving data into temporary files and with minimum memory usage.</p>
</div>
<div class="section" id="table-functions">
<span id="tablefunctions"></span><h2>Table Functions<a class="headerlink" href="#table-functions" title="Permalink to this headline">¶</a></h2>
<p>In certain case, for example when testing report builder modules, it may be necessary to access .yml files from the command line using <strong>gorpipe</strong>. In this case you can use the following syntax:</p>
<div class="highlight-gor notranslate"><div class="highlight"><pre><span></span>gorpipe &quot; <span class="nd">gor</span> /&lt;path&gt;/&lt;to&gt;/&lt;report_builder.yml&gt;
(arg1=val1,arg2=val2,ref_path=/mnt/csa/volumes/ref01/ref/versions/hg19/HG19-85-5-4)&quot;
</pre></div>
</div>
<p>or for a more concrete example:</p>
<div class="highlight-gor notranslate"><div class="highlight"><pre><span></span>gorpipe &quot; <span class="nd">gor</span> ./nextcode/data_man/queries/report_builders/genes/pathways_to_genes.yml
(format=line_per_gene,pathways=REACTOME||Interleukin-1_processing,running_time=1,long_running_query=No,
ref_path=/mnt/csa/volumes/ref01/ref/versions/hg19/HG19-85-5-4) &quot;
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="parallelGOR.html" class="btn btn-neutral float-right" title="Parallelization in GOR" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="variantData.html" class="btn btn-neutral float-left" title="Variation Data" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020 GOR Open Source Project

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>